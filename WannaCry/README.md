# WannaCry 
***Note:*** This will not a be full reverse enginering of the malware . this report will only present the key points of the sample . 
## Persistence : 
the classic persistence techniques : <br/>
- new registry Keys in ***HKEY_CURRENT_MACHINE*** , ***HKEY_CURRENT_USER*** to restart automaticly once the user login .<br/><br/>
![WhatsApp Image 2021-08-03 at 14 37 31](https://user-images.githubusercontent.com/57273771/128078980-2c862a95-5b0d-4c57-a306-df8143e090ca.jpeg)<br/><br/>
- new service created and flags set to start automaticly . labeled ***"Microsof Security Service 2.0"***  <br/><br/>
![WhatsApp Image 2021-08-03 at 14 37 31 (1)](https://user-images.githubusercontent.com/57273771/128079991-9c3200d1-6a31-4cec-8339-3a187828fb35.jpeg)<br/><br/>
- choosing what bitcoin address will be used to make the money transfer .<br/><br/>
![WhatsApp Image 2021-08-03 at 16 32 42](https://user-images.githubusercontent.com/57273771/128082390-2dfc6e67-9c2d-417b-8d86-2dd84e03a9e1.jpeg)<br/>
 
## Obfuscation and embedded ressources
- File Functions are not in the import section , they are actually imported manually by ***GetProcAddr*** after retrieving a HANDLe to ***KERNEL32.dll*** , probably to not get detected by AV as Ransomware .<br/><br/>
![obfus](https://user-images.githubusercontent.com/57273771/128081507-47e0e8ed-3e7f-4fc7-8efa-8ee02ffbc3db.PNG)<br/><br/>
- .rsrc section contains an embedded zip file encrypted with the password ***WNcry@2o17***, it contains many files ( msg after encryption , u.wnry , c.wnry , ... ) , this zip will be decrypted , some files will get copied to ***C:\Windows*** , ***C:\ProgramData*** , some files contains some encryption keys , for example taskse.exe contains RSA key that will be used to decrypt an AES key in t.wnry here's the AES key after decryption : <br/>
``` bee19b98d2e5b12211ce211eecb13de6 ```

- with this key the malware will decrypt a large buffer in t.wnry , start of the large buffer 

```
f ee d8 08 1c 8a 71 e5  98 5c 17 8e 39 60 f2 8d  |......q..\..9`..|
00000010  da 74 ba cc cc cb 09 61  d9 ac be cc e8 c2 96 d1  |.t.....a........|
00000020  28 7c d7 38 fd 4c cd 07  94 ed 36 37 f0 67 6a 72  |(|.8.L....67.gjr|
00000030  53 1c 7c c6 65 fe cd 03  66 f5 46 69 90 9a 0e 17  |S.|.e...f.Fi....|
00000040  1b bd 5c 9f 12 92 72 f9  6b b0 21 64 ea d1 fc ee  |..\...r.k.!d....|
00000050  d9 b4 f0 38 c5 a4 27 67  31 79 2b fb df 27 ff 69  |...8..'g1y+..'.i|
00000060  31 74 b3 4c e4 3e af 75  fb 0e 3a e3 e7 85 f7 14  |1t.L.>.u..:.....|
00000070  b5 fd 3c cb 66 4e e2 bb  3a 54 66 7b aa aa 4d 85  |..<.fN..:Tf{..M.|
00000080  f7 a7 b8 fd 57 95 fb c6  f6 fc 5f b8 ed 96 1e 01  |....W....._.....|
00000090  0a d2 5f 3a fd 7f f3 b6  72 52 28 bc 4d 1d b9 41  |.._:....rR(.M..A|
000000a0  3f 3a d1 fb 8e 48 1e 57  a3 7f f9 ea 06 3d 6c e0  |?:...H.W.....=l.|
000000b0  0a 82 f4 1f 98 72 cd c6  66 a5 1b 4a 58 f0 d1 ce  |.....r..f..JX...|
000000c0  3a 86 7a 1d 72 43 ff 04  c5 f4 d2 66 03 58 20 51  |:.z.rC.....f.X Q|
000000d0  78 01 34 ba dd e7 f2 32  01 0f a1 89 26 77 2b 92  |x.4....2....&w+.|
000000e0  a4 26 6b 44 71 46 55 c5  c3 75 88 a0 80 bb a2 fb  |.&kDqFU..u......|
000000f0  f6 df 05 fe a5 e6 14 53  67 b0 c1 34 6b a1 f7 3c  |.......Sg..4k..<|
00000100  35 f4 5a 64 24 46 03 45  44 d6 90 ab d6 31 c6 53  |5.Zd$F.ED....1.S|
00000110  f1 64 de fc 20 80 65 57  a5 69 eb e6 9e e0 e3 70  |.d.. .eW.i.....p|
00000120  c9 32 cb b6 83 26 e2 7e  53 c3 6c 08 52 38 24 26  |.2...&.~S.l.R8$&|
00000130  71 e1 9b 4c 33 d0 3c a0  32 a0 80 d8 e2 78 20 08  |q..L3.<.2....x .|
00000140  f0 62 79 05 7a 4f c6 8e  77 dc 20 98 68 73 12 71  |.by.zO..w. .hs.q|
00000150  8a ca cb 8d 02 a7 49 cd  a2 31 2e b4 44 85 46 0d  |......I..1..D.F.|
00000160  1c 1c 4a 29 b3 26 88 ac  cb f6 eb 53 44 d6 97 7f  |..J).&.....SD...|
00000170  76 9b a2 6d 09 f7 df 56  0e 07 d8 d3 02 47 de ee  |v..m...V.....G..|
00000180  e2 42 60 f6 75 3e 4b 40  ca 5c 5f 4e d9 c8 d2 c2  |.B`.u>K@.\_N....|
00000190  ac 1d 83 23 ea 81 7c d0  f4 77 95 c0 f0 dd e9 5a  |...#..|..w.....Z|
000001a0  dd 29 ab 58 94 d7 5b a4  e5 6f 81 28 a4 27 f2 7e  |.).X..[..o.(.'.~|
000001b0  e3 99 a4 6e 71 ee 68 71  31 e2 9d fa 8d da ef 3a  |...nq.hq1......:|
000001c0  21 c9 84 51 c9 50 96 d0  8c e6 63 da 4b 41 2c be  |!..Q.P....c.KA,.|
...
```

, that will result in a DLL . <br/>
## Encryption 
The Dll decrypted in the one responsible for encryption , the encryption works  checking for all logical drives , if any exists it will create new thread to encrypt them .
- it will generate a random AES key , then it will encrypt the files with that key , and encrypt the key with RSA public key and save it to the encrypted files.

